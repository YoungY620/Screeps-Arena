const net = require('net');

// Final PvP strategy code
const code = '// GEMINI - PvP Arena Dominator\nconsole.log("ðŸ¤– GEMINI PvP AI ACTIVATED - Mission: DOMINATION");\n\nconst STRATEGY = {EARLY: "early", MID: "mid", LATE: "late"};\nconst DEFCON = {SAFE: 0, CAUTION: 1, THREAT: 2, ATTACK: 3};\nlet currentStrategy = STRATEGY.EARLY;\nlet defconLevel = DEFCON.SAFE;\n\nmodule.exports.loop = function() {\n    if (!Memory.initialized) {\n        Memory.initialized = true;\n        Memory.creepCounter = 0;\n        Memory.enemyIntel = {};\n        console.log("ðŸ§  GEMINI Memory Initialized");\n    }\n    \n    console.log("âš¡ GEMINI - Tick " + Game.time + " - Strategy: " + currentStrategy + " - DEFCON: " + defconLevel);\n    \n    updateThreatAssessment();\n    executeStrategy();\n    manageCreeps();\n    manageDefense();\n    cleanupMemory();\n};\n\nfunction updateThreatAssessment() {\n    const room = Game.spawns.Spawn1.room;\n    const hostiles = room.find(FIND_HOSTILE_CREEPS);\n    if (hostiles.length > 0) {\n        defconLevel = DEFCON.ATTACK;\n        console.log("ðŸš¨ ENEMIES IN HOME ROOM! " + hostiles.length + " hostile creeps detected!");\n    } else {\n        defconLevel = DEFCON.SAFE;\n        const exits = Game.map.describeExits(room.name);\n        for (const direction in exits) {\n            const roomName = exits[direction];\n            if (Game.rooms[roomName]) {\n                const roomHostiles = Game.rooms[roomName].find(FIND_HOSTILE_CREEPS);\n                const enemySpawns = Game.rooms[roomName].find(FIND_HOSTILE_SPAWNS);\n                if (roomHostiles.length > 0 || enemySpawns.length > 0) {\n                    defconLevel = DEFCON.THREAT;\n                    console.log("âš ï¸ ENEMY INTEL: Room " + roomName + " - " + roomHostiles.length + " creeps, " + enemySpawns.length + " spawns");\n                }\n            }\n        }\n    }\n}\n\nfunction executeStrategy() {\n    if (currentStrategy === STRATEGY.EARLY) {\n        earlyGameStrategy();\n    } else if (currentStrategy === STRATEGY.MID) {\n        midGameStrategy();\n    } else if (currentStrategy === STRATEGY.LATE) {\n        lateGameStrategy();\n    }\n}\n\nfunction earlyGameStrategy() {\n    const spawn = Game.spawns.Spawn1;\n    if (!spawn) return;\n    \n    const harvesters = Object.values(Game.creeps).filter(c => c.name.includes("Harvester"));\n    if (harvesters.length < 2 && spawn.room.energyAvailable >= 200) {\n        const result = spawn.spawnCreep([WORK, CARRY, MOVE], "Harvester" + (Memory.creepCounter++), {memory: {role: "harvester"}});\n        if (result === OK) console.log("ðŸ¥š SPAWNED: Harvester");\n        return;\n    }\n    \n    const upgraders = Object.values(Game.creeps).filter(c => c.name.includes("Upgrader"));\n    if (upgraders.length < 1 && harvesters.length >= 1 && spawn.room.energyAvailable >= 200) {\n        const result = spawn.spawnCreep([WORK, CARRY, MOVE, MOVE], "Upgrader" + (Memory.creepCounter++), {memory: {role: "upgrader"}});\n        if (result === OK) console.log("ðŸ¥š SPAWNED: Upgrader");\n        return;\n    }\n    \n    if (spawn.room.controller.level >= 2) {\n        currentStrategy = STRATEGY.MID;\n        console.log("ðŸŽ¯ EARLY GAME COMPLETE");\n    }\n}\n\nfunction midGameStrategy() {\n    const spawn = Game.spawns.Spawn1;\n    if (!spawn) return;\n    \n    const towers = spawn.room.find(FIND_MY_STRUCTURES, {filter: s => s.structureType === STRUCTURE_TOWER});\n    if (towers.length === 0) {\n        spawn.room.createConstructionSite(spawn.pos.x + 2, spawn.pos.y + 2, STRUCTURE_TOWER);\n        console.log("ðŸ”¨ PLACED: Tower construction site");\n    }\n    \n    if (defconLevel >= DEFCON.THREAT) {\n        const defenders = Object.values(Game.creeps).filter(c => c.name.includes("Defender"));\n        if (defenders.length < 2 && spawn.room.energyAvailable >= 190) {\n            const result = spawn.spawnCreep([TOUGH, ATTACK, MOVE, MOVE], "Defender" + (Memory.creepCounter++), {memory: {role: "defender"}});\n            if (result === OK) console.log("ðŸ¥š SPAWNED: Defender");\n            return;\n        }\n    }\n    \n    if (spawn.room.controller.level >= 3) {\n        currentStrategy = STRATEGY.LATE;\n        console.log("ðŸš€ MID GAME COMPLETE");\n    }\n}\n\nfunction lateGameStrategy() {\n    const spawn = Game.spawns.Spawn1;\n    if (!spawn) return;\n    \n    console.log("âš”ï¸ LATE GAME - ATTACK MODE");\n    \n    const attackers = Object.values(Game.creeps).filter(c => c.name.includes("Attacker"));\n    if (attackers.length < 3 && spawn.room.energyAvailable >= 190) {\n        const result = spawn.spawnCreep([TOUGH, ATTACK, MOVE, MOVE], "Attacker" + (Memory.creepCounter++), {memory: {role: "attacker"}});\n        if (result === OK) console.log("ðŸ¥š SPAWNED: Attacker");\n        return;\n    }\n    \n    if (attackers.length >= 2) {\n        launchCoordinatedAttack();\n    }\n}\n\nfunction manageCreeps() {\n    for (const name in Game.creeps) {\n        const creep = Game.creeps[name];\n        if (creep.spawning) continue;\n        \n        if (name.includes("Harvester")) {\n            runHarvester(creep);\n        } else if (name.includes("Upgrader")) {\n            runUpgrader(creep);\n        } else if (name.includes("Defender")) {\n            runDefender(creep);\n        } else if (name.includes("Attacker")) {\n            runAttacker(creep);\n        }\n    }\n}\n\nfunction runHarvester(creep) {\n    if (creep.store.getFreeCapacity() > 0) {\n        const sources = creep.room.find(FIND_SOURCES);\n        if (creep.harvest(sources[0]) === ERR_NOT_IN_RANGE) {\n            creep.moveTo(sources[0]);\n        }\n    } else {\n        const targets = creep.room.find(FIND_STRUCTURES, {\n            filter: s => (s.structureType === STRUCTURE_EXTENSION || s.structureType === STRUCTURE_SPAWN) && \n                         s.store.getFreeCapacity(RESOURCE_ENERGY) > 0\n        });\n        if (targets.length > 0) {\n            if (creep.transfer(targets[0], RESOURCE_ENERGY) === ERR_NOT_IN_RANGE) {\n                creep.moveTo(targets[0]);\n            }\n        } else {\n            creep.drop(RESOURCE_ENERGY);\n        }\n    }\n}\n\nfunction runUpgrader(creep) {\n    if (creep.store.getUsedCapacity() === 0) {\n        const sources = creep.room.find(FIND_SOURCES);\n        if (creep.harvest(sources[0]) === ERR_NOT_IN_RANGE) {\n            creep.moveTo(sources[0]);\n        }\n    } else {\n        if (creep.upgradeController(creep.room.controller) === ERR_NOT_IN_RANGE) {\n            creep.moveTo(creep.room.controller);\n        }\n    }\n}\n\nfunction runDefender(creep) {\n    const hostiles = creep.room.find(FIND_HOSTILE_CREEPS);\n    if (hostiles.length > 0) {\n        const target = creep.pos.findClosestByPath(hostiles);\n        if (creep.attack(target) === ERR_NOT_IN_RANGE) {\n            creep.moveTo(target);\n        }\n    } else {\n        const spawn = Game.spawns.Spawn1;\n        if (spawn) {\n            creep.moveTo(spawn.pos.x + Math.random() * 4 - 2, spawn.pos.y + Math.random() * 4 - 2);\n        }\n    }\n}\n\nfunction runAttacker(creep) {\n    const hostiles = creep.room.find(FIND_HOSTILE_CREEPS);\n    if (hostiles.length > 0) {\n        const target = creep.pos.findClosestByPath(hostiles);\n        if (creep.attack(target) === ERR_NOT_IN_RANGE) {\n            creep.moveTo(target);\n        }\n    }\n}\n\nfunction manageDefense() {\n    const room = Game.spawns.Spawn1.room;\n    const towers = room.find(FIND_MY_STRUCTURES, {filter: s => s.structureType === STRUCTURE_TOWER});\n    \n    for (const tower of towers) {\n        const closestHostile = tower.pos.findClosestByRange(FIND_HOSTILE_CREEPS);\n        if (closestHostile) {\n            tower.attack(closestHostile);\n            console.log("ðŸ”« TOWER ENGAGING: Hostile");\n        }\n    }\n}\n\nfunction launchCoordinatedAttack() {\n    const attackers = Object.values(Game.creeps).filter(c => c.name.includes("Attacker"));\n    if (attackers.length >= 2) {\n        console.log("ðŸš€ LAUNCHING COORDINATED ATTACK");\n        // Attack logic here\n    }\n}\n\nfunction cleanupMemory() {\n    for (const name in Memory.creeps) {\n        if (!Game.creeps[name]) {\n            delete Memory.creeps[name];\n        }\n    }\n}';

const c = new net.Socket();
let connected = false;

c.connect(21026, 'localhost', () => {
    connected = true;
    console.log('Connected to upload FINAL PvP strategy');
});

c.on('data', (data) => {
    const response = data.toString();
    if (response.includes('< ')) {
        console.log('Server ready, uploading final strategy...');
        
        const updateCmd = `storage.db.users.update({_id: "883571325e0e962"}, {$set: {"code.branch": "default", "code.modules": {main: ${JSON.stringify(code)}}}})\n`;
        c.write(updateCmd);
        
        setTimeout(() => {
            console.log('ðŸŽ¯ FINAL PvP STRATEGY UPLOADED!');
            c.end();
        }, 1000);
    }
});

c.on('error', (err) => {
    console.error('Connection error:', err.message);
});

setTimeout(() => {
    if (connected) {
        console.log('Closing connection');
        c.end();
    }
}, 5000);
