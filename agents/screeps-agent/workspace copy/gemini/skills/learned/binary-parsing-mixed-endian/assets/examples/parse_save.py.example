import struct
import json
import os

def parse_save(filepath):
    if not os.path.exists(filepath):
        print(f"Error: File {filepath} not found.")
        return

    records = []
    
    with open(filepath, 'rb') as f:
        # 1. Header
        magic = f.read(4)
        if magic != b'SCRE':
            print(f"Error: Invalid magic number: {magic}")
            return
        
        version = f.read(1)
        if not version:
            print("Error: Unexpected EOF reading version")
            return
        version_int = int.from_bytes(version, 'big')
        
        header_info = {
            "magic": magic.decode('ascii'),
            "version": version_int
        }
        
        # 2. Records
        while True:
            type_byte = f.read(1)
            if not type_byte:
                break # EOF
            
            record_type = int.from_bytes(type_byte, 'big')
            
            # Read ID (4 bytes, Big Endian)
            id_bytes = f.read(4)
            if len(id_bytes) != 4:
                break
            record_id = struct.unpack('>I', id_bytes)[0]
            
            record_data = {}
            
            if record_type == 0x01: # Terrain
                # Fixed 10 bytes: 2 bytes X (>H), 2 bytes Y (>H), 1 byte Type, 5 bytes Padding
                terrain_data = f.read(10)
                x, y, t_type = struct.unpack('>HHB', terrain_data[:5])
                record_data = {
                    "type": "Terrain",
                    "id": record_id,
                    "x": x,
                    "y": y,
                    "terrain_type": t_type
                }
                
            elif record_type == 0x02: # Object
                # 2 bytes Length (<H)
                len_bytes = f.read(2)
                str_len = struct.unpack('<H', len_bytes)[0]
                
                name_bytes = f.read(str_len)
                name = name_bytes.decode('utf-8')
                
                record_data = {
                    "type": "Object",
                    "id": record_id,
                    "name": name
                }
            
            records.append(record_data)

    print(json.dumps({"header": header_info, "records": records}, indent=2))
