{"branch":"default","modules":{"main":"// üö® EMERGENCY COMBAT PROTOCOL v5.0 üö®\n// IMMEDIATE BATTLE RESPONSE - NO TIME TO WASTE\n\nconst BATTLE_STATUS = {\n    PEACE: 0,\n    THREAT_DETECTED: 1,\n    ACTIVE_COMBAT: 2,\n    CRITICAL_DEFENSE: 3,\n    SPAWN_DESTROYED: 4,\n    TOTAL_WAR: 5\n};\n\nlet battleState = {\n    status: BATTLE_STATUS.SPAWN_DESTROYED,\n    enemyDetected: true,\n    spawnDestroyed: true,\n    lastCombatTick: 0,\n    roomName: 'W1N3',\n    emergencyMode: true,\n    totalWarDeclared: false,\n    enemyRooms: new Set(),\n    attackTargets: []\n};\n\n// EMERGENCY military units - Maximum damage, minimum cost\nconst emergencyBodies = {\n    defender: [ATTACK, ATTACK, MOVE, MOVE], // Cheap but effective\n    \n    kamikaze: [ATTACK, ATTACK, ATTACK, MOVE, MOVE, MOVE], // Pure offense\n    \n    guard: [TOUGH, ATTACK, MOVE, MOVE], // Defense focused\n    \n    scout: [MOVE, MOVE], // Ultra cheap recon\n    \n    warrior: [TOUGH, TOUGH, ATTACK, ATTACK, MOVE, MOVE, MOVE], // Balanced fighter\n    \n    archer: [RANGED_ATTACK, RANGED_ATTACK, MOVE, MOVE], // Ranged support\n    \n    healer: [HEAL, HEAL, MOVE, MOVE], // Support unit\n    \n    assassin: [MOVE, MOVE, MOVE, ATTACK, ATTACK, ATTACK] // Fast killer\n};\n\n// EMERGENCY roles - Prioritize combat readiness\nconst emergencyRoles = {\n    defender: {\n        body: emergencyBodies.defender,\n        maxCount: 10,\n        priority: 1,\n        emergency: true\n    },\n    \n    kamikaze: {\n        body: emergencyBodies.kamikaze,\n        maxCount: 8,\n        priority: 2,\n        emergency: true\n    },\n    \n    warrior: {\n        body: emergencyBodies.warrior,\n        maxCount: 6,\n        priority: 3,\n        emergency: true\n    },\n    \n    archer: {\n        body: emergencyBodies.archer,\n        maxCount: 6,\n        priority: 4,\n        emergency: true\n    },\n    \n    healer: {\n        body: emergencyBodies.healer,\n        maxCount: 4,\n        priority: 5,\n        emergency: true\n    },\n    \n    scout: {\n        body: emergencyBodies.scout,\n        maxCount: 3,\n        priority: 6,\n        emergency: true\n    },\n    \n    harvester: {\n        body: [WORK, WORK, CARRY, MOVE],\n        maxCount: 6,\n        priority: 7,\n        emergency: false\n    },\n    \n    builder: {\n        body: [WORK, CARRY, CARRY, MOVE],\n        maxCount: 4,\n        priority: 8,\n        emergency: false\n    }\n};\n\n// EMERGENCY defense - Build while under attack\nconst emergencyDefense = {\n    buildEmergencyRamparts: function(room) {\n        // Build ramparts in a cross pattern around controller if spawn is destroyed\n        const controller = room.controller;\n        if (!controller) return;\n        \n        const rampartPositions = [\n            {x: controller.pos.x - 1, y: controller.pos.y},\n            {x: controller.pos.x + 1, y: controller.pos.y},\n            {x: controller.pos.x, y: controller.pos.y - 1},\n            {x: controller.pos.x, y: controller.pos.y + 1},\n            {x: controller.pos.x - 1, y: controller.pos.y - 1},\n            {x: controller.pos.x + 1, y: controller.pos.y - 1},\n            {x: controller.pos.x - 1, y: controller.pos.y + 1},\n            {x: controller.pos.x + 1, y: controller.pos.y + 1}\n        ];\n        \n        rampartPositions.forEach(pos => {\n            const structures = room.lookForAt(LOOK_STRUCTURES, pos.x, pos.y);\n            const hasWall = structures.some(s => s.structureType === STRUCTURE_RAMPART);\n            \n            if (!hasWall && room.createConstructionSite(pos.x, pos.y, STRUCTURE_RAMPART) === OK) {\n                console.log(`üõ°Ô∏è EMERGENCY Rampart at ${pos.x},${pos.y}`);\n            }\n        });\n    },\n    \n    buildEmergencyTowers: function(room) {\n        const controller = room.controller;\n        if (!controller) return;\n        \n        const towerPositions = [\n            {x: controller.pos.x - 3, y: controller.pos.y - 3},\n            {x: controller.pos.x + 3, y: controller.pos.y - 3},\n            {x: controller.pos.x - 3, y: controller.pos.y + 3},\n            {x: controller.pos.x + 3, y: controller.pos.y + 3}\n        ];\n        \n        towerPositions.forEach(pos => {\n            if (room.createConstructionSite(pos.x, pos.y, STRUCTURE_TOWER) === OK) {\n                console.log(`üèóÔ∏è EMERGENCY Tower at ${pos.x},${pos.y}`);\n            }\n        });\n    },\n    \n    buildEmergencyExtensions: function(room) {\n        const controller = room.controller;\n        if (!controller) return;\n        \n        for (let x = controller.pos.x - 5; x <= controller.pos.x + 5; x++) {\n            for (let y = controller.pos.y - 5; y <= controller.pos.y + 5; y++) {\n                if (Math.abs(x - controller.pos.x) + Math.abs(y - controller.pos.y) > 2) {\n                    if (room.createConstructionSite(x, y, STRUCTURE_EXTENSION) === OK) {\n                        console.log(`üîã EMERGENCY Extension at ${x},${y}`);\n                }\n                }\n            }\n        }\n    },\n    \n    activateEmergencyTowers: function(room) {\n        const towers = room.find(FIND_MY_STRUCTURES, {\n            filter: { structureType: STRUCTURE_TOWER }\n        });\n        \n        let enemiesEngaged = 0;\n        \n        towers.forEach(tower => {\n            // KILL ENEMY HEALERS FIRST\n            const hostileHealers = tower.room.find(FIND_HOSTILE_CREEPS, {\n                filter: hostile => hostile.getActiveBodyparts(HEAL) > 0\n            });\n            \n            if (hostileHealers.length > 0) {\n                const target = tower.pos.findClosestByRange(hostileHealers);\n                if (target) {\n                    tower.attack(target);\n                    console.log(`üí• EMERGENCY Tower EXECUTING healer!`);\n                    enemiesEngaged++;\n                    return;\n                }\n            }\n            \n            // KILL ENEMY ATTACKERS\n            const hostileAttackers = tower.room.find(FIND_HOSTILE_CREEPS, {\n                filter: hostile => {\n                    return hostile.getActiveBodyparts(ATTACK) > 0 || hostile.getActiveBodyparts(RANGED_ATTACK) > 0;\n                }\n            });\n            \n            if (hostileAttackers.length > 0) {\n                const target = tower.pos.findClosestByRange(hostileAttackers);\n                if (target) {\n                    tower.attack(target);\n                    console.log(`‚öîÔ∏è EMERGENCY Tower ELIMINATING attacker!`);\n                    enemiesEngaged++;\n                    return;\n                }\n            }\n            \n            // ATTACK ANY HOSTILE\n            const closestHostile = tower.pos.findClosestByRange(FIND_HOSTILE_CREEPS);\n            if (closestHostile) {\n                tower.attack(closestHostile);\n                console.log(`‚öîÔ∏è EMERGENCY Tower ATTACKING hostile`);\n                enemiesEngaged++;\n                return;\n            }\n            \n            // HEAL DAMAGED ALLIES\n            const damagedAlly = tower.pos.findClosestByRange(FIND_MY_CREEPS, {\n                filter: creep => creep.hits < creep.hitsMax * 0.7\n            });\n            \n            if (damagedAlly) {\n                tower.heal(damagedAlly);\n                console.log(`üíö EMERGENCY Tower HEALING ally`);\n            }\n        });\n        \n        return enemiesEngaged;\n    }\n};\n\n// EMERGENCY combat tactics - Fight to survive\nconst emergencyCombat = {\n    engageEnemy: function(creep) {\n        // Find nearest hostile and attack\n        const hostiles = creep.room.find(FIND_HOSTILE_CREEPS);\n        if (hostiles.length === 0) return false;\n        \n        const target = creep.pos.findClosestByRange(hostiles);\n        if (!target) return false;\n        \n        // Prioritize healers first\n        if (target.getActiveBodyparts(HEAL) > 0) {\n            console.log(`üéØ ${creep.name} TARGETING ENEMY HEALER!`);\n        }\n        \n        // Attack or move to attack\n        if (creep.attack(target) === ERR_NOT_IN_RANGE) {\n            creep.moveTo(target, {visualizePathStyle: {stroke: '#ff0000'}});\n        }\n        \n        return true;\n    },\n    \n    launchImmediateAttack: function(targetRoom) {\n        console.log(`üöÄüö® EMERGENCY ATTACK ON ${targetRoom}!`);\n        \n        // Count available attack forces\n        const attackers = Object.keys(Game.creeps).filter(name => {\n            const creep = Game.creeps[name];\n            return (creep.memory.role === 'attacker' || creep.memory.role === 'kamikaze' || \n                   creep.memory.role === 'warrior' || creep.memory.role === 'assassin') && \n                   creep.room.name === battleState.roomName;\n        }).length;\n        \n        const healers = Object.keys(Game.creeps).filter(name => {\n            const creep = Game.creeps[name];\n            return creep.memory.role === 'healer' && creep.room.name === battleState.roomName;\n        }).length;\n        \n        console.log(`üö® EMERGENCY forces: ${attackers} attackers, ${healers} healers`);\n        \n        // Launch attack with any available forces\n        if (attackers >= 1) {\n            Object.keys(Game.creeps).forEach(name => {\n                const creep = Game.creeps[name];\n                if (creep.room.name === battleState.roomName) {\n                    if (creep.memory.role === 'attacker' || creep.memory.role === 'kamikaze' || \n                        creep.memory.role === 'warrior' || creep.memory.role === 'assassin') {\n                        creep.memory.targetRoom = targetRoom;\n                        creep.memory.mode = 'attack';\n                        console.log(`üö® ${name} EMERGENCY ATTACK ORDER on ${targetRoom}`);\n                    }\n                    if (creep.memory.role === 'healer') {\n                        creep.memory.targetRoom = targetRoom;\n                        creep.memory.mode = 'support';\n                        console.log(`üíö ${name} EMERGENCY SUPPORT ORDER on ${targetRoom}`);\n                    }\n                }\n            });\n            \n            battleState.lastAttackTime = Game.time;\n            battleState.attackWaveSize = attackers;\n        } else {\n            console.log(`‚ö†Ô∏è INSUFFICIENT FORCES for emergency attack`);\n        }\n    }\n};\n\n// EMERGENCY roles - Fight or die\nconst emergencyRoles = {\n    defender: function(creep) {\n        // Defend at all costs\n        if (!emergencyCombat.engageEnemy(creep)) {\n            // No enemies, patrol or build\n            const targets = creep.room.find(FIND_CONSTRUCTION_SITES);\n            if (targets.length > 0) {\n                if (creep.build(targets[0]) === ERR_NOT_IN_RANGE) {\n                    creep.moveTo(targets[0]);\n                }\n            } else {\n                creep.moveTo(new RoomPosition(25, 25, creep.room.name));\n            }\n        }\n    },\n    \n    kamikaze: function(creep) {\n        // Suicide attack - no retreat\n        if (creep.memory.targetRoom && creep.room.name !== creep.memory.targetRoom) {\n            creep.moveTo(new RoomPosition(25, 25, creep.memory.targetRoom), {visualizePathStyle: {stroke: '#ff0000'}});\n            return;\n        }\n        \n        // Find highest value target\n        const targets = [\n            ...creep.room.find(FIND_HOSTILE_SPAWNS),\n            ...creep.room.find(FIND_HOSTILE_STRUCTURES, {filter: {structureType: STRUCTURE_TOWER}}),\n            ...creep.room.find(FIND_HOSTILE_CREEPS, {filter: c => c.getActiveBodyparts(HEAL) > 0}),\n            ...creep.room.find(FIND_HOSTILE_CREEPS, {filter: c => c.getActiveBodyparts(ATTACK) > 0 || c.getActiveBodyparts(RANGED_ATTACK) > 0}),\n            ...creep.room.find(FIND_HOSTILE_CREEPS)\n        ];\n        \n        if (targets.length > 0) {\n            const target = creep.pos.findClosestByRange(targets);\n            if (creep.attack(target) === ERR_NOT_IN_RANGE) {\n                creep.moveTo(target, {visualizePathStyle: {stroke: '#ff0000'}});\n            }\n            console.log(`üíÄüö® KAMIKAZE ${creep.name} ATTACKING ${target.structureType || 'CREEP'}!`);\n        }\n    },\n    \n    warrior: function(creep) {\n        // Professional combat unit\n        if (creep.memory.targetRoom && creep.room.name !== creep.memory.targetRoom) {\n            creep.moveTo(new RoomPosition(25, 25, creep.memory.targetRoom), {visualizePathStyle: {stroke: '#ff0000'}});\n            return;\n        }\n        \n        if (!emergencyCombat.engageEnemy(creep)) {\n            // No enemies, patrol\n            creep.moveTo(new RoomPosition(Math.random() * 40 + 10, Math.random() * 40 + 10, creep.room.name));\n        }\n    },\n    \n    archer: function(creep) {\n        // Ranged combat support\n        if (creep.memory.targetRoom && creep.room.name !== creep.memory.targetRoom) {\n            creep.moveTo(new RoomPosition(25, 25, creep.memory.targetRoom), {visualizePathStyle: {stroke: '#ff0000'}});\n            return;\n        }\n        \n        const hostiles = creep.room.find(FIND_HOSTILE_CREEPS);\n        if (hostiles.length > 0) {\n            const target = creep.pos.findClosestByRange(hostiles);\n            if (creep.rangedAttack(target) === ERR_NOT_IN_RANGE) {\n                creep.moveTo(target, {visualizePathStyle: {stroke: '#ff0000'}});\n            } else {\n                if (creep.pos.getRangeTo(target) <= 3) {\n                    creep.rangedMassAttack();\n                }\n            }\n        } else if (creep.memory.mode === 'attack' && creep.memory.targetRoom) {\n            creep.moveTo(new RoomPosition(25, 25, creep.memory.targetRoom), {visualizePathStyle: {stroke: '#ff0000'}});\n        } else {\n            creep.moveTo(new RoomPosition(Math.random() * 40 + 10, Math.random() * 40 + 10, creep.room.name));\n        }\n    },\n    \n    healer: function(creep) {\n        // Combat medic\n        if (creep.memory.targetRoom && creep.room.name !== creep.memory.targetRoom && creep.memory.mode === 'support') {\n            creep.moveTo(new RoomPosition(25, 25, creep.memory.targetRoom), {visualizePathStyle: {stroke: '#00ff00'}});\n            return;\n        }\n        \n        // Heal military allies first\n        const militaryAllies = creep.room.find(FIND_MY_CREEPS, {\n            filter: ally => (ally.memory.role === 'warrior' || ally.memory.role === 'archer' || \n                           ally.memory.role === 'attacker' || ally.memory.role === 'kamikaze' || \n                           ally.memory.role === 'defender' || ally.memory.role === 'assassin') && \n                           ally.hits < ally.hitsMax\n        });\n        \n        if (militaryAllies.length > 0) {\n            const target = creep.pos.findClosestByRange(militaryAllies);\n            if (creep.heal(target) === ERR_NOT_IN_RANGE) {\n                creep.moveTo(target, {visualizePathStyle: {stroke: '#00ff00'}});\n            }\n            return;\n        }\n        \n        // Heal any damaged ally\n        const damagedAlly = creep.pos.findClosestByRange(FIND_MY_CREEPS, {\n            filter: ally => ally.hits < ally.hitsMax\n        });\n        \n        if (damagedAlly) {\n            if (creep.heal(damagedAlly) === ERR_NOT_IN_RANGE) {\n                creep.moveTo(damagedAlly, {visualizePathStyle: {stroke: '#00ff00'}});\n            }\n            return;\n        }\n        \n        // Follow military units\n        const militaryUnits = creep.room.find(FIND_MY_CREEPS, {\n            filter: ally => ['warrior', 'archer', 'attacker', 'kamikaze', 'defender', 'assassin'].includes(ally.memory.role)\n        });\n        \n        if (militaryUnits.length > 0) {\n            const target = creep.pos.findClosestByRange(militaryUnits);\n            if (creep.pos.getRangeTo(target) > 2) {\n                creep.moveTo(target, {visualizePathStyle: {stroke: '#00ff00'}});\n            }\n        }\n    },\n    \n    scout: function(creep) {\n        // Quick reconnaissance\n        const enemyRooms = ['W1N1', 'W1N2', 'W1N4', 'W1N5', 'W2N1', 'W2N2', 'W2N3', 'W0N1', 'W0N2', 'W0N3'];\n        const targetRoom = enemyRooms[Math.floor(Math.random() * enemyRooms.length)];\n        \n        if (creep.room.name !== targetRoom) {\n            creep.moveTo(new RoomPosition(25, 25, targetRoom), {visualizePathStyle: {stroke: '#00ff00'}});\n            return;\n        }\n        \n        // Report enemy activity\n        const hostiles = creep.room.find(FIND_HOSTILE_CREEPS);\n        const enemyStructures = creep.room.find(FIND_HOSTILE_STRUCTURES);\n        \n        if (hostiles.length > 0 || enemyStructures.length > 0) {\n            battleState.enemyRooms.add(creep.room.name);\n            console.log(`üö® EMERGENCY SCOUT Enemy in ${creep.room.name}!`);\n        }\n        \n        // Keep moving to survive\n        creep.moveTo(new RoomPosition(Math.random() * 40 + 10, Math.random() * 40 + 10, creep.room.name));\n    },\n    \n    harvester: function(creep) {\n        // Keep economy running during war\n        if (creep.store.getFreeCapacity() > 0) {\n            const sources = creep.room.find(FIND_SOURCES);\n            if (sources.length > 0) {\n                if (creep.harvest(sources[0]) === ERR_NOT_IN_RANGE) {\n                    creep.moveTo(sources[0], {visualizePathStyle: {stroke: '#ffaa00'}});\n                }\n            }\n        } else {\n            const targets = creep.room.find(FIND_STRUCTURES, {\n                filter: (structure) => {\n                    return (structure.structureType === STRUCTURE_EXTENSION ||\n                            structure.structureType === STRUCTURE_SPAWN ||\n                            structure.structureType === STRUCTURE_TOWER) &&\n                            structure.store.getFreeCapacity(RESOURCE_ENERGY) > 0;\n                }\n            });\n            if (targets.length > 0) {\n                if (creep.transfer(targets[0], RESOURCE_ENERGY) === ERR_NOT_IN_RANGE) {\n                    creep.moveTo(targets[0], {visualizePathStyle: {stroke: '#ffffff'}});\n                }\n            }\n        }\n    },\n    \n    builder: function(creep) {\n        // Build defenses during combat\n        const targets = creep.room.find(FIND_CONSTRUCTION_SITES);\n        if (targets.length) {\n            if (creep.store[RESOURCE_ENERGY] === 0) {\n                const sources = creep.room.find(FIND_SOURCES);\n                if (sources.length > 0) {\n                    if (creep.harvest(sources[0]) === ERR_NOT_IN_RANGE) {\n                        creep.moveTo(sources[0], {visualizePathStyle: {stroke: '#ffaa00'}});\n                    }\n                }\n            } else {\n                if (creep.build(targets[0]) === ERR_NOT_IN_RANGE) {\n                    creep.moveTo(targets[0], {visualizePathStyle: {stroke: '#ffffff'}});\n                }\n            }\n        } else {\n            // No construction, help harvest\n            emergencyRoles.harvester(creep);\n        }\n    },\n    \n    assassin: function(creep) {\n        // Fast execution unit\n        if (creep.memory.targetRoom && creep.room.name !== creep.memory.targetRoom) {\n            creep.moveTo(new RoomPosition(25, 25, creep.memory.targetRoom), {visualizePathStyle: {stroke: '#ff0000'}});\n            return;\n        }\n        \n        // Target high-value enemies\n        const enemyHealers = creep.room.find(FIND_HOSTILE_CREEPS, {\n            filter: hostile => hostile.getActiveBodyparts(HEAL) > 0\n        });\n        \n        if (enemyHealers.length > 0) {\n            const target = creep.pos.findClosestByRange(enemyHealers);\n            if (creep.attack(target) === ERR_NOT_IN_RANGE) {\n                creep.moveTo(target, {visualizePathStyle: {stroke: '#aa0000'}});\n            }\n            return;\n        }\n        \n        // Attack any enemy\n        emergencyCombat.engageEnemy(creep);\n    }\n};\n\n// EMERGENCY spawn management\nconst emergencySpawn = {\n    spawnCreep: function(spawn, role) {\n        const roleConfig = emergencyRoles[role];\n        if (!roleConfig) return null;\n        \n        const body = roleConfig.body;\n        const name = `${role}_${Game.time}_${Math.floor(Math.random() * 1000)}`;\n        \n        const result = spawn.spawnCreep(body, name, {\n            memory: {\n                role: role,\n                born: Game.time,\n                emergency: true\n            }\n        });\n        \n        if (result === OK) {\n            console.log(`üö® EMERGENCY Spawned ${role}: ${name}`);\n            return name;\n        }\n        \n        return null;\n    },\n    \n    manageEmergencySpawning: function(spawn) {\n        if (spawn.spawning) return;\n        \n        const room = spawn.room;\n        const currentCreeps = Object.keys(Game.creeps);\n        \n        // Count creeps by role in this room\n        const roomCreeps = {};\n        currentCreeps.forEach(name => {\n            const creep = Game.creeps[name];\n            if (creep.memory.role && creep.room.name === room.name) {\n                roomCreeps[creep.memory.role] = (roomCreeps[creep.memory.role] || 0) + 1;\n            }\n        });\n        \n        console.log(`üö® EMERGENCY Creeps: ${JSON.stringify(roomCreeps)}`);\n        \n        // EMERGENCY PRIORITY: Military units first\n        if (battleState.status >= BATTLE_STATUS.THREAT_DETECTED) {\n            if (roomCreeps.defender < 4) {\n                emergencySpawn.spawnCreep(spawn, 'defender');\n                return;\n            }\n            if (roomCreeps.kamikaze < 3) {\n                emergencySpawn.spawnCreep(spawn, 'kamikaze');\n                return;\n            }\n            if (roomCreeps.warrior < 3) {\n                emergencySpawn.spawnCreep(spawn, 'warrior');\n                return;\n            }\n            if (roomCreeps.archer < 2) {\n                emergencySpawn.spawnCreep(spawn, 'archer');\n                return;\n            }\n            if (roomCreeps.healer < 2) {\n                emergencySpawn.spawnCreep(spawn, 'healer');\n                return;\n            }\n        }\n        \n        // Secondary: Scouts and economy\n        if (roomCreeps.scout < 2) {\n            emergencySpawn.spawnCreep(spawn, 'scout');\n            return;\n        }\n        \n        if (roomCreeps.harvester < 4) {\n            emergencySpawn.spawnCreep(spawn, 'harvester');\n            return;\n        }\n        \n        if (roomCreeps.builder < 2) {\n            emergencySpawn.spawnCreep(spawn, 'builder');\n            return;\n        }\n    }\n};\n\n// Main EMERGENCY loop - SURVIVE AT ALL COSTS\nmodule.exports.loop = function() {\n    // Update battle state\n    battleState.currentTick = Game.time;\n    \n    // Clear dead creeps\n    for (const name in Memory.creeps) {\n        if (!Game.creeps[name]) {\n            delete Memory.creeps[name];\n            console.log(`üíÄ EMERGENCY Cleared dead creep: ${name}`);\n        }\n    }\n    \n    const room = Game.rooms[battleState.roomName];\n    if (!room) {\n        console.log(`‚ùå EMERGENCY Room ${battleState.roomName} not found!`);\n        return;\n    }\n    \n    // IMMEDIATE THREAT ASSESSMENT\n    const hostiles = room.find(FIND_HOSTILE_CREEPS);\n    const enemyStructures = room.find(FIND_HOSTILE_STRUCTURES);\n    const enemySpawns = room.find(FIND_HOSTILE_SPAWNS);\n    const enemyTowers = room.find(FIND_HOSTILE_STRUCTURES, {\n        filter: { structureType: STRUCTURE_TOWER }\n    });\n    \n    if (hostiles.length > 0 || enemyStructures.length > 0) {\n        battleState.lastCombatTick = Game.time;\n        battleState.enemyDetected = true;\n        \n        // Determine threat level\n        const dangerousEnemies = hostiles.filter(e => \n            e.getActiveBodyparts(ATTACK) > 0 || e.getActiveBodyparts(RANGED_ATTACK) > 0\n        ).length;\n        \n        if (enemySpawns.length > 0 || enemyTowers.length > 0) {\n            battleState.status = BATTLE_STATUS.TOTAL_WAR;\n            battleState.totalWarDeclared = true;\n            console.log(`üö® TOTAL WAR DECLARED - Enemy structures detected!`);\n        } else if (dangerousEnemies >= 3) {\n            battleState.status = BATTLE_STATUS.CRITICAL_DEFENSE;\n            console.log(`üö® CRITICAL DEFENSE MODE - Multiple attackers detected!`);\n        } else if (dangerousEnemies > 0) {\n            battleState.status = BATTLE_STATUS.ACTIVE_COMBAT;\n            console.log(`üö® ACTIVE COMBAT MODE - Enemy attackers detected!`);\n        } else {\n            battleState.status = BATTLE_STATUS.THREAT_DETECTED;\n            console.log(`üö® THREAT DETECTED - Non-combat hostiles in room!`);\n        }\n    } else {\n        battleState.enemyDetected = false;\n        const timeSinceCombat = Game.time - battleState.lastCombatTick;\n        \n        if (timeSinceCombat > 100) {\n            battleState.status = BATTLE_STATUS.PEACE;\n            console.log(`‚úÖ PEACE MODE - No enemies detected`);\n        } else if (timeSinceCombat > 50) {\n            battleState.status = BATTLE_STATUS.THREAT_DETECTED;\n            console.log(`‚ö†Ô∏è THREAT DETECTED - Recent combat activity`);\n        }\n    }\n    \n    // Check spawn status\n    const spawn = Game.spawns.Spawn1;\n    if (!spawn) {\n        battleState.spawnDestroyed = true;\n        battleState.status = BATTLE_STATUS.SPAWN_DESTROYED;\n        console.log(`üíÄ SPAWN DESTROYED - Operating in emergency mode!`);\n    } else if (spawn.hits < spawn.hitsMax) {\n        console.log(`‚ö†Ô∏è SPAWN DAMAGED - ${spawn.hits}/${spawn.hitsMax} HP`);\n    }\n    \n    // EMERGENCY CONSTRUCTION - Build while fighting\n    if (Game.time % 5 === 0) {\n        if (battleState.spawnDestroyed) {\n            emergencyDefense.buildEmergencyRamparts(room);\n            emergencyDefense.buildEmergencyExtensions(room);\n        }\n        emergencyDefense.buildEmergencyTowers(room);\n    }\n    \n    // ACTIVATE TOWERS - Kill enemies immediately\n    const towersEngaged = emergencyDefense.activateEmergencyTowers(room);\n    \n    // EMERGENCY SPAWNING - Replace losses immediately\n    if (spawn) {\n        emergencySpawn.manageEmergencySpawning(spawn);\n    }\n    \n    // EXECUTE EMERGENCY ROLES - Every creep fights\n    for (const name in Game.creeps) {\n        const creep = Game.creeps[name];\n        if (creep.spawning) continue;\n        \n        const role = creep.memory.role;\n        if (emergencyRoles[role]) {\n            try {\n                emergencyRoles[role](creep);\n            } catch (error) {\n                console.log(`‚ùå EMERGENCY Error in ${role} ${name}: ${error}`);\n            }\n        }\n    }\n    \n    // IMMEDIATE COUNTER-ATTACK - Strike back fast\n    if (Game.time % 20 === 0 && battleState.status >= BATTLE_STATUS.ACTIVE_COMBAT) {\n        const targetRooms = ['W1N1', 'W1N2', 'W1N4', 'W1N5', 'W2N1', 'W2N2'];\n        const targetRoom = targetRooms[Math.floor(Math.random() * targetRooms.length)];\n        emergencyCombat.launchImmediateAttack(targetRoom);\n    }\n    \n    // CONTINUOUS RECON - Always know enemy positions\n    if (Game.time % 30 === 0) {\n        // Send scouts to gather intelligence\n        const scouts = Object.keys(Game.creeps).filter(name => {\n            const creep = Game.creeps[name];\n            return creep.memory.role === 'scout' && creep.room.name === battleState.roomName;\n        });\n        \n        if (scouts.length > 0) {\n            const scoutName = scouts[0];\n            const scout = Game.creeps[scoutName];\n            if (scout) {\n                emergencyRoles.scout(scout);\n            }\n        }\n    }\n    \n    // EMERGENCY STATUS REPORT\n    if (Game.time % 5 === 0) {\n        const statusNames = ['PEACE', 'THREAT_DETECTED', 'ACTIVE_COMBAT', 'CRITICAL_DEFENSE', 'SPAWN_DESTROYED', 'TOTAL_WAR'];\n        const hostiles = room.find(FIND_HOSTILE_CREEPS).length;\n        const militaryCreeps = Object.keys(Game.creeps).filter(name => {\n            const creep = Game.creeps[name];\n            return ['defender', 'warrior', 'archer', 'attacker', 'kamikaze', 'assassin'].includes(creep.memory.role) && \n                   creep.room.name === battleState.roomName;\n        }).length;\n        \n        console.log(`üö® EMERGENCY: ${statusNames[battleState.status]} | Hostiles: ${hostiles} | Military: ${militaryCreeps} | Energy: ${room.energyAvailable}/${room.energyCapacityAvailable} | Creeps: ${Object.keys(Game.creeps).length}`);\n        \n        if (battleState.totalWarDeclared) {\n            console.log(`üî•üî•üî• TOTAL WAR - NO MERCY FOR ENEMIES! üî•üî•üî•`);\n        }\n        \n        if (battleState.spawnDestroyed) {\n            console.log(`üíÄ SPAWN DESTROYED - FIGHTING WITHOUT RESPAWN!`);\n        }\n    }\n};"}}